<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<title>WebGL App</title>
</head>
<body style='overflow:hidden;margin:0;background-color:#888'>

<script id='shader-fs' type='text/x-fragment_shader'>

precision lowp float;

uniform float u_time;
uniform vec2 translate;
uniform vec2 scale;
uniform float rotate;
uniform float r;
uniform float g;
uniform float b;

void main(void) {

  float x = ( gl_FragCoord.x + translate.x ) * scale.x;
  float y = ( gl_FragCoord.y + translate.y ) * scale.y; //  + 1.0

  float sin_theta = sin(rotate);
  float cos_theta = cos(rotate);

  float x2 = cos_theta * x - sin_theta * y;
  float y2 = sin_theta * x + cos_theta * y;

  x = x2;
  y = y2;

  float z = 0.0;

  // function to calculate z from x and y
  //z = x - y; // line
  //z = x * x - y; // parabola
  z = x * x + y * y; // circle
  //z = 0.0 - x * x - x * y - y * y;  // phi
  //z = -2.0 * x * x + x * x * x * x + 2.0 * y * y + 2.0 * x * x * y * y + y * y * y * y;  // lemniscate of bernoulli
  //z = 0.0 - x * x + x * x * x * x + y * y;  // lemniscate of gerono
  //z = x * x * x - 3.0 * x * y + y * y * y;  // folium of descartes

  // animate by varying the result with u_time
  z = z * -u_time;

  // grey
  //gl_FragColor.r = gl_FragColor.g = gl_FragColor.b = z;

  // set pixel colours
  gl_FragColor.r = z + r;
  gl_FragColor.g = z + g;
  gl_FragColor.b = z + b;


}

</script>

<script id='shader-vs' type='text/x-vertex_shader'>

attribute vec3 a_position;
attribute vec4 a_color;
varying vec4 v_color;

void main(void) {

  gl_Position = vec4(a_position, 1);
  v_color = a_color;

}

</script>

<script type="module">
'set strict'

import {sWebGL} from './sWebGL.mjs'
import {sMouse} from './sMouse.mjs'
import {sKeys} from './sKeys.mjs'

window.onload = function() {

  // Keep track of where the mouse was while dragging
  var mouse_left_drag_last_position = [0, 0]

  var swgl = new sWebGL({
    plugins: {

      'mouse': new sMouse({
        onDown: {

          // left-click: Record position for dragging
          0: function() {
            mouse_left_drag_last_position = swgl.plugins.mouse.p.slice(0)
          },

          // middle-click: Reset
          1: function() {
            swgl.zoom = 1 / 32
            swgl.incrementZoom(0)
            swgl.moveToCentre()
          },

        },
        whileDown: {

          // left-click: Move by dragging
          0: function() {
            var mouse_delta = [
              mouse_left_drag_last_position[0] - swgl.plugins.mouse.p[0],
              mouse_left_drag_last_position[1] - swgl.plugins.mouse.p[1]
            ]
            mouse_left_drag_last_position = swgl.plugins.mouse.p.slice(0)
            swgl.move(-mouse_delta[0], mouse_delta[1])
          },

          // right-click: Move towards drag position
          2: function() {
            swgl.move(
              (swgl.canvas.centre[0] - swgl.plugins.mouse.p[0]) / 32,
              (swgl.canvas.centre[1] - swgl.plugins.mouse.p[1]) / -32
            )
          },

        },
        onWheel: function(i) {
          swgl.incrementZoom(-i)
        }
      }),

      'keys': new sKeys({
        onDown: {

          // +: Zoom in
          107: function() {
            swgl.incrementZoom(1)
          },
          // -: Zoom out
          109: function() {
            swgl.incrementZoom(-1)
          },

          // up: Up
          38: function() {
            swgl.move(0, 32)
          },
          // left: Left
          37: function() {
            swgl.move(-32, 0)
          },
          // down: Down
          40: function() {
            swgl.move(0, -32)
          },
          // right: Right
          39: function() {
            swgl.move(32, 0)
          },

          // w: Up
          87: function() {
            swgl.move(0, 1)
          },
          // a: Left
          65: function() {
            swgl.move(-1, 0)
          },
          // s: Down
          83: function() {
            swgl.move(0, -1)
          },
          // d: Right
          68: function() {
            swgl.move(1, 0)
          }

        }
      })

    }
  })
}

</script>

</body>
</html>
