<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
<title>Barnsley Fern Visualizer</title>
<style>
body {
  overflow: hidden;
  margin: 0;
  background-color: #000;
}
input[type=number] {
  width: 80px;
}
input[type=range] {
  width: 420px;
}
</style>
</head>
<body>

<script id='shader-fs' type='text/x-fragment_shader'>

precision lowp float;

uniform vec4 u_color;

void main() {
  gl_FragColor = u_color;
}

</script>

<script id='shader-vs' type='text/x-vertex_shader'>

attribute vec2 a_position;

uniform vec2 u_transform;

uniform vec2 u_resolution;

void main() {

  // convert from pixels to 0...1
  vec2 clip_space = a_position / u_resolution;

  // scale
  clip_space *= u_resolution.y * 0.185;

  // translate
  clip_space += u_transform;

  gl_Position = vec4(clip_space, 0.0, 1.0);

  //gl_PointSize = 1.0;

}

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>

<script type="module">
'set strict'

import {sWebGL} from './sWebGL.mjs'
import {sParams} from './sParams.mjs'
import {sPanel} from './sPanel.mjs'
//import {sMouse} from './sMouse.mjs'
import {BarnsleyFern} from './BarnsleyFern.mjs'

window.onload = function() {

  // Keep track of where the mouse was while dragging
  var mouse_left_drag_last_position = [0, 0]

  // Keep track of when each button is pressed to determine which button was pressed first
  var mouse_left_last_click = 0
  var mouse_right_last_click = 0

  // Get params from URL hash and update URL when they change
  var param_handler = new sParams()

  // Default params
  param_handler.params = {

      // Scroll position
      x:  0.0,
      y: -1.0,

      // Fern iterations
      iterations: 1<<15,

  }

  // Update params in URL hash
  param_handler.update()

  // Init Web GL
  var swgl = new sWebGL({
    /*
    plugins: {
      'mouse': new sMouse({
        onDown: {

          // left-click
          0: function() {
            mouse_left_last_click = + new Date()

            // Record position for dragging
            mouse_left_drag_last_position = swgl.plugins.mouse.p.slice(0)
          },

          // middle-click
          1: function() {
            // Reset view
            param_handler.params.x = param_handler.params.y = 0
            param_handler.params.sx = param_handler.params.sy = 1
            param_handler.params.r = 0
          },

          // right-click
          2: function() {
            mouse_right_last_click = + new Date()
          },

        },
        whileDown: {

          // left-click
          0: function() {
            // if right-click is not also pressed
            if (swgl.plugins.mouse.b[2] === 0) {
              // Move by dragging
              var mouse_delta = [
                swgl.xToScreenBasis(mouse_left_drag_last_position[0]) - swgl.xToScreenBasis(swgl.plugins.mouse.p[0]),
                swgl.yToScreenBasis(mouse_left_drag_last_position[1]) - swgl.yToScreenBasis(swgl.plugins.mouse.p[1])
              ]
              mouse_left_drag_last_position = swgl.plugins.mouse.p.slice(0)
              swgl.move(
                //swgl.xFromScreenBasis(mouse_delta[0]),
                //swgl.yFromScreenBasis(mouse_delta[1])
                -mouse_delta[0],
                mouse_delta[1]
              )
            }
            else {
              // Rotate
              if (mouse_left_last_click > mouse_right_last_click) {
                swgl.rotate(0.001)
              }
              else {
                swgl.rotate(-0.001)
              }
            }
          },

          // right-click
          2: function() {
            // ignore when left-click is also pressed
            if (swgl.plugins.mouse.b[0] !== 0) {
              return
            }
            // move towards drag position
            swgl.move(
              (swgl.canvas.centre[0] - swgl.plugins.mouse.p[0]) / 4096,
              -(swgl.canvas.centre[1] - swgl.plugins.mouse.p[1]) / 4096
            )
          },

        },
        onWheel: function(i) {
          swgl.incrementZoom(-i, swgl.plugins.mouse.p)
        },

      }),
    }        */
  })

  // Draw the fern
  var fern = new BarnsleyFern()

  swgl.drawScene = function() {

    swgl.gl.clear(swgl.gl.COLOR_BUFFER_BIT)

    // Reset initial position
    fern.reset()

    // Iterate through transformations, drawing each position
    fern.iterate(
      param_handler.params.iterations,
      function (position) {
        swgl.drawPixel(position)
      }
    )
  }

  // Draw the fern control panel
  var panel = new sPanel()

  panel.drawSliders(fern.transformation_probabilities, 'p', {min: 0, max: 1})
  panel.drawSliders(fern.transformation_matrices, 'm')
  panel.drawSliders(fern.transformation_vectors, 'v')

}

</script>

</body>
</html>
